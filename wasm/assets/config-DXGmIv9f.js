var st=Object.defineProperty;var at=(t,n,u)=>n in t?st(t,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[n]=u;var N=(t,n,u)=>at(t,typeof n!="symbol"?n+"":n,u);import{s as ut,t as P}from"./chunk-DZLz74EQ.js";import{o as V,r as ht}from"./react-7g8sREeT.js";import{r as ct,t as lt}from"./invariant-91cSKJcr.js";import{t as j}from"./Logger-BkkOJyg0.js";import{t as ft}from"./utils-DBmmAf_K.js";import{n as F}from"./constants-Cv7-oioA.js";import{t as dt}from"./Deferred-Mppm0cvJ.js";function z(){return typeof document<"u"&&document.querySelector("marimo-wasm")!==null}function q(){return(window==null?void 0:window.__MARIMO_STATIC__)!==void 0}function pt(){return lt(window.__MARIMO_STATIC__!==void 0,"Not a static notebook"),window.__MARIMO_STATIC__.files}var gt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.add=b,t.fromBig=w,t.split=d;var n=BigInt(2**32-1),u=BigInt(32);function w(o,i=!1){return i?{h:Number(o&n),l:Number(o>>u&n)}:{h:Number(o>>u&n)|0,l:Number(o&n)|0}}function d(o,i=!1){let e=o.length,l=new Uint32Array(e),U=new Uint32Array(e);for(let S=0;S<e;S++){let{h:B,l:W}=w(o[S],i);[l[S],U[S]]=[B,W]}return[l,U]}var v=(o,i)=>BigInt(o>>>0)<<u|BigInt(i>>>0);t.toBig=v;var x=(o,i,e)=>o>>>e;t.shrSH=x;var E=(o,i,e)=>o<<32-e|i>>>e;t.shrSL=E;var C=(o,i,e)=>o>>>e|i<<32-e;t.rotrSH=C;var T=(o,i,e)=>o<<32-e|i>>>e;t.rotrSL=T;var _=(o,i,e)=>o<<64-e|i>>>e-32;t.rotrBH=_;var H=(o,i,e)=>o>>>e-32|i<<64-e;t.rotrBL=H;var M=(o,i)=>i;t.rotr32H=M;var $=(o,i)=>o;t.rotr32L=$;var O=(o,i,e)=>o<<e|i>>>32-e;t.rotlSH=O;var A=(o,i,e)=>i<<e|o>>>32-e;t.rotlSL=A;var p=(o,i,e)=>i<<e-32|o>>>64-e;t.rotlBH=p;var m=(o,i,e)=>o<<e-32|i>>>64-e;t.rotlBL=m;function b(o,i,e,l){let U=(i>>>0)+(l>>>0);return{h:o+e+(U/2**32|0)|0,l:U|0}}var g=(o,i,e)=>(o>>>0)+(i>>>0)+(e>>>0);t.add3L=g;var R=(o,i,e,l)=>i+e+l+(o/2**32|0)|0;t.add3H=R;var c=(o,i,e,l)=>(o>>>0)+(i>>>0)+(e>>>0)+(l>>>0);t.add4L=c;var s=(o,i,e,l,U)=>i+e+l+U+(o/2**32|0)|0;t.add4H=s;var h=(o,i,e,l,U)=>(o>>>0)+(i>>>0)+(e>>>0)+(l>>>0)+(U>>>0);t.add5L=h;var f=(o,i,e,l,U,S)=>i+e+l+U+S+(o/2**32|0)|0;t.add5H=f,t.default={fromBig:w,split:d,toBig:v,shrSH:x,shrSL:E,rotrSH:C,rotrSL:T,rotrBH:_,rotrBL:H,rotr32H:M,rotr32L:$,rotlSH:O,rotlSL:A,rotlBH:p,rotlBL:m,add:b,add3L:g,add3H:R,add4L:c,add4H:s,add5H:f,add5L:h}})),wt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0})),yt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.Hash=t.nextTick=t.swap32IfBE=t.byteSwapIfBE=t.swap8IfBE=t.isLE=void 0,t.isBytes=u,t.anumber=w,t.abytes=d,t.ahash=v,t.aexists=x,t.aoutput=E,t.u8=C,t.u32=T,t.clean=_,t.createView=H,t.rotr=M,t.rotl=$,t.byteSwap=O,t.byteSwap32=A,t.bytesToHex=b,t.hexToBytes=c,t.asyncLoop=s,t.utf8ToBytes=h,t.bytesToUtf8=f,t.toBytes=o,t.kdfInputToBytes=i,t.concatBytes=e,t.checkOpts=l,t.createHasher=U,t.createOptHasher=S,t.createXOFer=B,t.randomBytes=W;var n=wt();function u(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function w(r){if(!Number.isSafeInteger(r)||r<0)throw Error("positive integer expected, got "+r)}function d(r,...a){if(!u(r))throw Error("Uint8Array expected");if(a.length>0&&!a.includes(r.length))throw Error("Uint8Array expected of length "+a+", got length="+r.length)}function v(r){if(typeof r!="function"||typeof r.create!="function")throw Error("Hash should be wrapped by utils.createHasher");w(r.outputLen),w(r.blockLen)}function x(r,a=!0){if(r.destroyed)throw Error("Hash instance has been destroyed");if(a&&r.finished)throw Error("Hash#digest() has already been called")}function E(r,a){d(r);let y=a.outputLen;if(r.length<y)throw Error("digestInto() expects output buffer of length at least "+y)}function C(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function T(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function _(...r){for(let a=0;a<r.length;a++)r[a].fill(0)}function H(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function M(r,a){return r<<32-a|r>>>a}function $(r,a){return r<<a|r>>>32-a>>>0}t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function O(r){return r<<24&4278190080|r<<8&16711680|r>>>8&65280|r>>>24&255}t.swap8IfBE=t.isLE?r=>r:r=>O(r),t.byteSwapIfBE=t.swap8IfBE;function A(r){for(let a=0;a<r.length;a++)r[a]=O(r[a]);return r}t.swap32IfBE=t.isLE?r=>r:A;var p=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",m=Array.from({length:256},(r,a)=>a.toString(16).padStart(2,"0"));function b(r){if(d(r),p)return r.toHex();let a="";for(let y=0;y<r.length;y++)a+=m[r[y]];return a}var g={_0:48,_9:57,A:65,F:70,a:97,f:102};function R(r){if(r>=g._0&&r<=g._9)return r-g._0;if(r>=g.A&&r<=g.F)return r-(g.A-10);if(r>=g.a&&r<=g.f)return r-(g.a-10)}function c(r){if(typeof r!="string")throw Error("hex string expected, got "+typeof r);if(p)return Uint8Array.fromHex(r);let a=r.length,y=a/2;if(a%2)throw Error("hex string expected, got unpadded hex of length "+a);let L=new Uint8Array(y);for(let k=0,I=0;k<y;k++,I+=2){let D=R(r.charCodeAt(I)),X=R(r.charCodeAt(I+1));if(D===void 0||X===void 0){let it=r[I]+r[I+1];throw Error('hex string expected, got non-hex character "'+it+'" at index '+I)}L[k]=D*16+X}return L}t.nextTick=async()=>{};async function s(r,a,y){let L=Date.now();for(let k=0;k<r;k++){y(k);let I=Date.now()-L;I>=0&&I<a||(await(0,t.nextTick)(),L+=I)}}function h(r){if(typeof r!="string")throw Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function f(r){return new TextDecoder().decode(r)}function o(r){return typeof r=="string"&&(r=h(r)),d(r),r}function i(r){return typeof r=="string"&&(r=h(r)),d(r),r}function e(...r){let a=0;for(let L=0;L<r.length;L++){let k=r[L];d(k),a+=k.length}let y=new Uint8Array(a);for(let L=0,k=0;L<r.length;L++){let I=r[L];y.set(I,k),k+=I.length}return y}function l(r,a){if(a!==void 0&&{}.toString.call(a)!=="[object Object]")throw Error("options should be object or undefined");return Object.assign(r,a)}t.Hash=class{};function U(r){let a=L=>r().update(o(L)).digest(),y=r();return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=()=>r(),a}function S(r){let a=(L,k)=>r(k).update(o(L)).digest(),y=r({});return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=L=>r(L),a}function B(r){let a=(L,k)=>r(k).update(o(L)).digest(),y=r({});return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=L=>r(L),a}t.wrapConstructor=U,t.wrapConstructorWithOpts=S,t.wrapXOFConstructorWithOpts=B;function W(r=32){if(n.crypto&&typeof n.crypto.getRandomValues=="function")return n.crypto.getRandomValues(new Uint8Array(r));if(n.crypto&&typeof n.crypto.randomBytes=="function")return Uint8Array.from(n.crypto.randomBytes(r));throw Error("crypto.getRandomValues must be defined")}})),Lt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.keccakP=m;var n=gt(),u=yt(),w=BigInt(0),d=BigInt(1),v=BigInt(2),x=BigInt(7),E=BigInt(256),C=BigInt(113),T=[],_=[],H=[];for(let c=0,s=d,h=1,f=0;c<24;c++){[h,f]=[f,(2*h+3*f)%5],T.push(2*(5*f+h)),_.push((c+1)*(c+2)/2%64);let o=w;for(let i=0;i<7;i++)s=(s<<d^(s>>x)*C)%E,s&v&&(o^=d<<(d<<BigInt(i))-d);H.push(o)}var M=(0,n.split)(H,!0),$=M[0],O=M[1],A=(c,s,h)=>h>32?(0,n.rotlBH)(c,s,h):(0,n.rotlSH)(c,s,h),p=(c,s,h)=>h>32?(0,n.rotlBL)(c,s,h):(0,n.rotlSL)(c,s,h);function m(c,s=24){let h=new Uint32Array(10);for(let f=24-s;f<24;f++){for(let e=0;e<10;e++)h[e]=c[e]^c[e+10]^c[e+20]^c[e+30]^c[e+40];for(let e=0;e<10;e+=2){let l=(e+8)%10,U=(e+2)%10,S=h[U],B=h[U+1],W=A(S,B,1)^h[l],r=p(S,B,1)^h[l+1];for(let a=0;a<50;a+=10)c[e+a]^=W,c[e+a+1]^=r}let o=c[2],i=c[3];for(let e=0;e<24;e++){let l=_[e],U=A(o,i,l),S=p(o,i,l),B=T[e];o=c[B],i=c[B+1],c[B]=U,c[B+1]=S}for(let e=0;e<50;e+=10){for(let l=0;l<10;l++)h[l]=c[e+l];for(let l=0;l<10;l++)c[e+l]^=~h[(l+2)%10]&h[(l+4)%10]}c[0]^=$[f],c[1]^=O[f]}(0,u.clean)(h)}var b=class ot extends u.Hash{constructor(s,h,f,o=!1,i=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=s,this.suffix=h,this.outputLen=f,this.enableXOF=o,this.rounds=i,(0,u.anumber)(f),!(0<s&&s<200))throw Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=(0,u.u32)(this.state)}clone(){return this._cloneInto()}keccak(){(0,u.swap32IfBE)(this.state32),m(this.state32,this.rounds),(0,u.swap32IfBE)(this.state32),this.posOut=0,this.pos=0}update(s){(0,u.aexists)(this),s=(0,u.toBytes)(s),(0,u.abytes)(s);let{blockLen:h,state:f}=this,o=s.length;for(let i=0;i<o;){let e=Math.min(h-this.pos,o-i);for(let l=0;l<e;l++)f[this.pos++]^=s[i++];this.pos===h&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:s,suffix:h,pos:f,blockLen:o}=this;s[f]^=h,h&128&&f===o-1&&this.keccak(),s[o-1]^=128,this.keccak()}writeInto(s){(0,u.aexists)(this,!1),(0,u.abytes)(s),this.finish();let h=this.state,{blockLen:f}=this;for(let o=0,i=s.length;o<i;){this.posOut>=f&&this.keccak();let e=Math.min(f-this.posOut,i-o);s.set(h.subarray(this.posOut,this.posOut+e),o),this.posOut+=e,o+=e}return s}xofInto(s){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(s)}xof(s){return(0,u.anumber)(s),this.xofInto(new Uint8Array(s))}digestInto(s){if((0,u.aoutput)(s,this),this.finished)throw Error("digest() was already called");return this.writeInto(s),this.destroy(),s}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,(0,u.clean)(this.state)}_cloneInto(s){let{blockLen:h,suffix:f,outputLen:o,rounds:i,enableXOF:e}=this;return s||(s=new ot(h,f,o,e,i)),s.state32.set(this.state32),s.pos=this.pos,s.posOut=this.posOut,s.finished=this.finished,s.rounds=i,s.suffix=f,s.outputLen=o,s.enableXOF=e,s.destroyed=this.destroyed,s}};t.Keccak=b;var g=(c,s,h)=>(0,u.createHasher)(()=>new b(s,c,h));t.sha3_224=g(6,144,224/8),t.sha3_256=g(6,136,256/8),t.sha3_384=g(6,104,384/8),t.sha3_512=g(6,72,512/8),t.keccak_224=g(1,144,224/8),t.keccak_256=g(1,136,256/8),t.keccak_384=g(1,104,384/8),t.keccak_512=g(1,72,512/8);var R=(c,s,h)=>(0,u.createXOFer)((f={})=>new b(s,c,f.dkLen===void 0?h:f.dkLen,!0));t.shake128=R(31,168,128/8),t.shake256=R(31,136,256/8)})),mt=P(((t,n)=>{var{sha3_512:u}=Lt(),w=24,d=32,v=(p=4,m=Math.random)=>{let b="";for(;b.length<p;)b+=Math.floor(m()*36).toString(36);return b};function x(p){let m=0n;for(let b of p.values()){let g=BigInt(b);m=(m<<8n)+g}return m}var E=(p="")=>x(u(p)).toString(36).slice(1),C=Array.from({length:26},(p,m)=>String.fromCharCode(m+97)),T=p=>C[Math.floor(p()*C.length)],_=({globalObj:p=typeof global<"u"?global:typeof window<"u"?window:{},random:m=Math.random}={})=>{let b=Object.keys(p).toString(),g=b.length?b+v(d,m):v(d,m);return E(g).substring(0,d)},H=p=>()=>p++,M=476782367,$=({random:p=Math.random,counter:m=H(Math.floor(p()*M)),length:b=w,fingerprint:g=_({random:p})}={})=>function(){let R=T(p),c=Date.now().toString(36),s=m().toString(36),h=v(b,p),f=`${c+h+s+g}`;return`${R+E(f).substring(1,b)}`},O=$(),A=(p,{minLength:m=2,maxLength:b=d}={})=>{let g=p.length,R=/^[0-9a-z]+$/;try{if(typeof p=="string"&&g>=m&&g<=b&&R.test(p))return!0}finally{}return!1};n.exports.getConstants=()=>({defaultLength:w,bigLength:d}),n.exports.init=$,n.exports.createId=O,n.exports.bufToBigInt=x,n.exports.createCounter=H,n.exports.createFingerprint=_,n.exports.isCuid=A})),K=P(((t,n)=>{var{createId:u,init:w,getConstants:d,isCuid:v}=mt();n.exports.createId=u,n.exports.init=w,n.exports.getConstants=d,n.exports.isCuid=v}));function G(t){return new URL(t,document.baseURI)}function J(t){let n=new URL(window.location.href);t(n.searchParams),window.history.replaceState({},"",n.toString())}function bt(t,n){if(typeof window>"u")return!1;let u=new URLSearchParams(window.location.search);return n===void 0?u.has(t):u.get(t)===n}function Ut(){let t=`__new__${Q()}`;return G(`?file=${t}`).toString()}var vt=/^(https?:\/\/\S+)$/;function kt(t){return typeof t=="string"&&vt.test(t)}var St=(0,ut(K()).init)({length:6});function Q(){return`s_${St()}`}function Y(t){return t?/^s_[\da-z]{6}$/.test(t):!1}var xt=(()=>{let t=new URL(window.location.href).searchParams.get(F.sessionId);return Y(t)?(J(n=>{n.has(F.kiosk)||n.delete(F.sessionId)}),j.debug("Connecting to existing session",{sessionId:t}),t):(j.debug("Starting a new session",{sessionId:t}),Q())})();function Z(){return xt}var It=class{constructor(t,n=!1){N(this,"initialHealthyCheck",new dt);this.config=t,this.lazy=n;try{new URL(this.config.url)}catch(u){throw Error(`Invalid runtime URL: ${this.config.url}. ${u instanceof Error?u.message:"Unknown error"}`)}this.lazy||this.init()}get httpURL(){return new URL(this.config.url)}get isSameOrigin(){return this.httpURL.origin===window.location.origin}formatHttpURL(t,n,u=!0){t||(t="");let w=this.httpURL,d=new URLSearchParams(window.location.search);if(n)for(let[v,x]of n.entries())w.searchParams.set(v,x);for(let[v,x]of d.entries())u&&!Object.values(F).includes(v)||w.searchParams.set(v,x);return w.pathname=`${w.pathname.replace(/\/$/,"")}/${t.replace(/^\//,"")}`,w.hash="",w}formatWsURL(t,n){let u=this.formatHttpURL(t,n,!1);return Rt(u.toString())}getWsURL(t){let n=new URL(this.config.url),u=new URLSearchParams(n.search);return new URLSearchParams(window.location.search).forEach((w,d)=>{u.has(d)||u.set(d,w)}),u.set(F.sessionId,t),this.formatWsURL("/ws",u)}getWsSyncURL(t){let n=new URL(this.config.url),u=new URLSearchParams(n.search);return new URLSearchParams(window.location.search).forEach((w,d)=>{u.has(d)||u.set(d,w)}),u.set(F.sessionId,t),this.formatWsURL("/ws_sync",u)}getTerminalWsURL(){return this.formatWsURL("/terminal/ws")}getLSPURL(t){if(t==="copilot"){let n=this.formatWsURL(`/lsp/${t}`);return n.search="",n}return this.formatWsURL(`/lsp/${t}`)}getAiURL(t){return this.formatHttpURL(`/api/ai/${t}`)}healthURL(){return this.formatHttpURL("/health")}async isHealthy(){if(z()||ft())return!0;try{let t=await fetch(this.healthURL().toString());if(t.redirected){let u=t.url.replace(/\/health$/,"");this.config.url=u}let n=t.ok;return n&&this.setDOMBaseUri(this.config.url),n}catch{return!1}}setDOMBaseUri(t){t=t.split("?",1)[0],t.endsWith("/")||(t+="/");let n=document.querySelector("base");n?n.setAttribute("href",t):(n=document.createElement("base"),n.setAttribute("href",t),document.head.append(n))}async init(t){let n=0;for(;!await this.isHealthy();){if(n>=25){j.error("Failed to connect after 25 retries"),this.initialHealthyCheck.reject(Error("Failed to connect after 25 retries"));return}if(!(t!=null&&t.disableRetryDelay)){let u=Math.min(100*1.2**n,2e3);await new Promise(w=>setTimeout(w,u))}n++}this.initialHealthyCheck.resolve()}async waitForHealthy(){return this.initialHealthyCheck.promise}headers(){let t={"Marimo-Session-Id":Z(),"Marimo-Server-Token":this.config.serverToken??"","x-runtime-url":this.httpURL.toString()};return this.config.authToken&&(t.Authorization=`Bearer ${this.config.authToken}`),t}};function Rt(t){if(!t.startsWith("http")){j.warn(`URL must start with http: ${t}`);let n=new URL(t);return n.protocol="ws",n}return new URL(t.replace(/^http/,"ws"))}function Bt(){let t=new URL(document.baseURI);return t.search="",t.hash="",t.toString()}const tt={url:Bt()},rt=V(tt);var nt=V(t=>{let n=t(rt),u=q();return new It(n,u)});function _t(){return ht(nt)}function et(){return ct.get(nt)}function Ht(t){if(t.startsWith("http"))return new URL(t);let n=et().httpURL.toString();return n.startsWith("blob:")&&(n=n.replace("blob:","")),new URL(t,n)}export{_t as a,bt as c,J as d,G as f,z as g,q as h,rt as i,kt as l,pt as m,Ht as n,Z as o,K as p,et as r,Y as s,tt as t,Ut as u};
