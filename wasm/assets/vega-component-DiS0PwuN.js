import{s as P}from"./chunk-DZLz74EQ.js";import"./jotai-BTnrNcC1.js";import{t as U}from"./react-BcIddLXZ.js";import"./react-dom-D6bRRS5R.js";import"./zod-U2NFpcFA.js";import{t as X}from"./compiler-runtime-Cr9loedd.js";import"./_Uint8Array-D5Z9rM2X.js";import"./isSymbol-xTSywenE.js";import"./toNumber-CTOPJrpu.js";import"./isArrayLikeObject-DKyJYtr8.js";import"./_getTag-CVRrQL_Q.js";import"./_baseUniq-DHpyQ0iZ.js";import"./_baseIsEqual-CVFfFJm2.js";import"./merge-Dvc5opZF.js";import"./now-BXqTLlmI.js";import{t as Y}from"./debounce-BUM2losY.js";import{r as tt,t as rt}from"./tooltip-BFMRXuzR.js";import{t as M}from"./uniq-pTjN93Sd.js";import{a as Z,u as S}from"./hotkeys-ClCtr3_I.js";import"./invariant-D5a0EE05.js";import"./utils-DEDX0RLo.js";import"./constants-CEISdYm1.js";import{n as V}from"./config-C6qInAhC.js";import"./useEventListener-D1FLsfmf.js";import{t as et}from"./jsx-runtime-mwDPpfh_.js";import"./clsx-BlAkgCmw.js";import"./cn-ZXtYmczU.js";import{r as nt}from"./button-ZC2axIBq.js";import"./Deferred-NfAvvkGM.js";import{n as at}from"./useTheme-Biy2QI0v.js";import"./createLucideIcon-CNVopWor.js";import{u as it}from"./toDate-C3oOx2yr.js";import"./Combination-BjaZc6gK.js";import"./dist-o-4-WxUj.js";import{t as ot}from"./tooltip-BHnVWzH0.js";import{t as lt}from"./isValid-BJSfXqfd.js";import"./alert-dialog-8EwWlboa.js";import{n as I}from"./useEvent-CRDKqG3C.js";import{n as ct}from"./error-banner-DoSAS3iD.js";import{n as st}from"./vega-loader.browser-D2m26-DP.js";import"./precisionRound-Qxa8hC2h.js";import"./linear-CPlUB2Oz.js";import{t as mt}from"./react-vega-CRwVRb9c.js";import"./ordinal-Dd9FQufD.js";import"./time-4HenLWop.js";import"./range-Dwpz5kHq.js";import"./defaultLocale-YmL2k7Vp.js";import"./defaultLocale-zQltfbSS.js";import{r as pt,t as ut}from"./alert-BqjCH_7t.js";import{n as ft}from"./useAsyncData-CngUoIwV.js";import"./dist-DBrqGLzW.js";import{t as z}from"./useDeepCompareMemoize-DiJVYA6I.js";import{t as dt}from"./formats-BN93kMCb.js";import"./timer-CTpu0Fa6.js";import"./path-CXR-wni1.js";import"./math-B-uM5inP.js";import"./arc-tAqWLv-B.js";import"./array-4wub28GG.js";import"./step-BDtirdXu.js";import"./line-DorFmRYv.js";import"./init-D34LU3qG.js";import"./colors-xHoM1JAe.js";import"./treemap-C6-dXGkc.js";var ht=P(X(),1),w=P(U(),1);function gt(t){return t.data&&"url"in t.data&&(t.data.url=V(t.data.url).href),t}const u={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"};var F=new Set(["boxplot","errorband","errorbar"]);const b={getMarkType(t){let r=typeof t=="string"?t:t.type;if(F.has(r))throw Error("Not supported");return r},isInteractive(t){let r=typeof t=="string"?t:t.type;return!F.has(r)},makeClickable(t){let r=typeof t=="string"?t:t.type;return r in u?typeof t=="string"?{type:t,cursor:"pointer",tooltip:!0}:{...t,type:r,cursor:"pointer",tooltip:!0}:t},getOpacity(t){return typeof t=="string"?null:"opacity"in t&&typeof t.opacity=="number"?t.opacity:null}},y={point(t){return t==null?"select_point":`select_point_${t}`},interval(t){return t==null?"select_interval":`select_interval_${t}`},legendSelection(t){return`legend_selection_${t}`},binColoring(t){return t==null?"bin_coloring":`bin_coloring_${t}`},HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint(t){return t.some(r=>r.startsWith("select_point"))},hasInterval(t){return t.some(r=>r.startsWith("select_interval"))},hasLegend(t){return t.some(r=>r.startsWith("legend_selection"))},hasPanZoom(t){return t.some(r=>r.startsWith("pan_zoom"))},isBinColoring(t){return t.startsWith("bin_coloring")}},A={highlight(){return{name:y.HIGHLIGHT,select:{type:"point",on:"mouseover"}}},interval(t,r){return{name:y.interval(r),select:{type:"interval",encodings:H(t),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}},point(t,r){return{name:y.point(r),select:{type:"point",encodings:H(t),on:"click[!event.metaKey]"}}},binColoring(t){return{name:y.binColoring(t),select:{type:"point",on:"click[!event.metaKey]"}}},legend(t){return{name:y.legendSelection(t),select:{type:"point",fields:[t]},bind:"legend"}},panZoom(){return{name:y.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}}}};function H(t){switch(b.getMarkType(t.mark)){case u.image:case u.trail:return;case u.area:case u.arc:return["color"];case u.bar:{let r=yt(t);return r==="horizontal"?["y"]:r==="vertical"?["x"]:void 0}case u.circle:case u.geoshape:case u.line:case u.point:case u.rect:case u.rule:case u.square:case u.text:case u.tick:return["x","y"]}}function O(t){return"params"in t&&t.params&&t.params.length>0?M(t.params.filter(r=>r==null?!1:"select"in r&&r.select!==void 0).map(r=>r.name)):"layer"in t?M(t.layer.flatMap(O)):"vconcat"in t?M(t.vconcat.flatMap(O)):"hconcat"in t?M(t.hconcat.flatMap(O)):[]}function yt(t){var a,e;if(!t||!("mark"in t))return;let r=(a=t.encoding)==null?void 0:a.x,n=(e=t.encoding)==null?void 0:e.y;if(r&&"type"in r&&r.type==="nominal")return"vertical";if(n&&"type"in n&&n.type==="nominal"||r&&"aggregate"in r)return"horizontal";if(n&&"aggregate"in n)return"vertical"}function vt(t){if(!t.encoding)return[];let r=[];for(let n of Object.values(t.encoding))n&&typeof n=="object"&&"bin"in n&&n.bin&&"field"in n&&typeof n.field=="string"&&r.push(n.field);return r}function W(t){if(!t||!("encoding"in t))return[];let{encoding:r}=t;return r?Object.entries(r).flatMap(n=>{let[a,e]=n;return!e||!kt.has(a)?[]:"field"in e&&typeof e.field=="string"?[e.field]:"condition"in e&&e.condition&&typeof e.condition=="object"&&"field"in e.condition&&e.condition.field&&typeof e.condition.field=="string"?[e.condition.field]:[]}):[]}var kt=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function D(t,r,n,a){let e=n.filter(l=>y.isBinColoring(l)),i={and:(e.length>0?e:n).map(l=>({param:l}))};switch(t){case"opacity":{let l=b.getOpacity(a)||1;return{...r,opacity:{condition:{test:i,value:l},value:l/5}}}default:return r}}function bt(t){if(!("select"in t)||!t.select)return JSON.stringify(t);let r=t.select;if(typeof r=="string")return JSON.stringify({type:r,bind:t.bind});let n={type:r.type,encodings:"encodings"in r&&r.encodings?[...r.encodings].sort():void 0,fields:"fields"in r&&r.fields?[...r.fields].sort():void 0,bind:t.bind};return JSON.stringify(n)}function G(t){let r=C(t);if(r.length===0)return t;let n=wt(r);return n.length===0?t:{...E(K(t,new Set(n.map(a=>a.name))),n.map(a=>a.name)),params:[...t.params||[],...n]}}function C(t){let r=[];if("vconcat"in t&&Array.isArray(t.vconcat))for(let n of t.vconcat)r.push(...C(n));else if("hconcat"in t&&Array.isArray(t.hconcat))for(let n of t.hconcat)r.push(...C(n));else{if("layer"in t)return[];"mark"in t&&"params"in t&&t.params&&t.params.length>0&&r.push({params:t.params})}return r}function wt(t){if(t.length===0)return[];let r=new Map,n=t.length;for(let{params:e}of t){let i=new Set;for(let l of e){let o=bt(l);i.has(o)||(i.add(o),r.has(o)||r.set(o,{count:0,param:l}),r.get(o).count++)}}let a=[];for(let[,{count:e,param:i}]of r)e===n&&a.push(i);return a}function K(t,r){if("vconcat"in t&&Array.isArray(t.vconcat))return{...t,vconcat:t.vconcat.map(n=>K(n,r))};if("hconcat"in t&&Array.isArray(t.hconcat))return{...t,hconcat:t.hconcat.map(n=>K(n,r))};if("mark"in t&&"params"in t&&t.params){let n=t.params,a=[];for(let e of n){if(!e||typeof e!="object"||!("name"in e)){a.push(e);continue}r.has(e.name)||a.push(e)}if(a.length===0){let{params:e,...i}=t;return i}return{...t,params:a}}return t}function E(t,r){return"vconcat"in t&&Array.isArray(t.vconcat)?{...t,vconcat:t.vconcat.map(n=>E(n,r))}:"hconcat"in t&&Array.isArray(t.hconcat)?{...t,hconcat:t.hconcat.map(n=>E(n,r))}:"layer"in t?t:"mark"in t&&b.isInteractive(t.mark)?{...t,mark:b.makeClickable(t.mark),encoding:D("opacity",t.encoding||{},r,t.mark)}:t}function T(t,r){var i,l;let{chartSelection:n=!0,fieldSelection:a=!0}=r;if(!n&&!a)return t;if((i=t.params)!=null&&i.some(o=>o.bind==="legend")&&(a=!1),(l=t.params)!=null&&l.some(o=>!o.bind)&&(n=!1),"vconcat"in t){let o=t.vconcat.map(s=>"mark"in s?T(s,{chartSelection:n,fieldSelection:a}):s);return G({...t,vconcat:o})}if("hconcat"in t){let o=t.hconcat.map(s=>"mark"in s?T(s,{chartSelection:n,fieldSelection:a}):s);return G({...t,hconcat:o})}if("layer"in t){let o=t.params&&t.params.length>0,s=a!==!1&&!o,d=[];if(s){let p=t.layer.flatMap(m=>"mark"in m?W(m):[]);d=[...new Set(p)],Array.isArray(a)&&(d=d.filter(m=>a.includes(m)))}let k=t.layer.map((p,m)=>{if(!("mark"in p))return p;let h=p;if(m===0&&d.length>0){let _=d.map(j=>A.legend(j));h={...h,params:[...h.params||[],..._]}}return h=L(h,n,m),h=q(h),m===0&&(h=$(h)),h});return{...t,layer:k}}if(!("mark"in t)||!b.isInteractive(t.mark))return t;let e=t;return e=xt(e,a),e=L(e,n,void 0),e=q(e),e=$(e),e}function xt(t,r){if(r===!1)return t;let n=W(t);Array.isArray(r)&&(n=n.filter(i=>r.includes(i)));let a=n.map(i=>A.legend(i)),e=[...t.params||[],...a];return{...t,params:e}}function L(t,r,n){if(r===!1)return t;let a;try{a=b.getMarkType(t.mark)}catch{return t}if(a==="geoshape")return t;let e=vt(t),i=r===!0?e.length>0?["point"]:St(a):[r];if(!i||i.length===0)return t;let l=i.map(s=>s==="interval"?A.interval(t,n):A.point(t,n)),o=[...t.params||[],...l];return e.length>0&&i.includes("point")&&o.push(A.binColoring(n)),{...t,params:o}}function $(t){let r;try{r=b.getMarkType(t.mark)}catch{}if(r==="geoshape")return t;let n=t.params||[];return n.some(a=>a.bind==="scales")?t:{...t,params:[...n,A.panZoom()]}}function q(t){let r="encoding"in t?t.encoding:void 0,n=t.params||[],a=n.map(e=>e.name);return n.length===0||!b.isInteractive(t.mark)?t:{...t,mark:b.makeClickable(t.mark),encoding:D("opacity",r||{},a,t.mark)}}function St(t){switch(t){case"arc":case"area":return["point"];case"text":case"bar":return["point","interval"];case"line":return;default:return["point","interval"]}}async function At(t){if(!t)return t;let r="datasets"in t?{...t.datasets}:{},n=async e=>{if(!e)return e;if("layer"in e){let o=await Promise.all(e.layer.map(n));e={...e,layer:o}}if("hconcat"in e){let o=await Promise.all(e.hconcat.map(n));e={...e,hconcat:o}}if("vconcat"in e){let o=await Promise.all(e.vconcat.map(n));e={...e,vconcat:o}}if("spec"in e&&(e={...e,spec:await n(e.spec)}),!e.data||!("url"in e.data))return e;let i;try{i=V(e.data.url)}catch{return e}let l=await tt(i.href,e.data.format);return r[i.pathname]=l,{...e,data:{name:i.pathname}}},a=await n(t);return Object.keys(r).length===0?a:{...a,datasets:r}}var f=P(et(),1);st("arrow",dt);var _t=t=>{let r=(0,ht.c)(11),{value:n,setValue:a,chartSelection:e,fieldSelection:i,spec:l}=t,o,s;r[0]===l?(o=r[1],s=r[2]):(o=async()=>At(l),s=[l],r[0]=l,r[1]=o,r[2]=s);let{data:d,error:k}=ft(o,s);if(k){let m;return r[3]===k?m=r[4]:(m=(0,f.jsx)(ct,{error:k}),r[3]=k,r[4]=m),m}if(!d)return null;let p;return r[5]!==e||r[6]!==i||r[7]!==d||r[8]!==a||r[9]!==n?(p=(0,f.jsx)(jt,{value:n,setValue:a,chartSelection:e,fieldSelection:i,spec:d}),r[5]=e,r[6]=i,r[7]=d,r[8]=a,r[9]=n,r[10]=p):p=r[10],p},jt=({value:t,setValue:r,chartSelection:n,fieldSelection:a,spec:e})=>{let{theme:i}=at(),l=(0,w.useRef)(null),o=(0,w.useRef)(void 0),[s,d]=(0,w.useState)(),k=z(e),p=(0,w.useMemo)(()=>T(gt(k),{chartSelection:n,fieldSelection:a}),[k,n,a]),m=(0,w.useMemo)(()=>O(p),[p]),h=I(c=>{r({...t,...c})}),_=(0,w.useMemo)(()=>Y((c,g)=>{S.debug("[Vega signal]",c,g);let v=Z.mapValues(g,Nt);v=Z.mapValues(v,Ot),h({[c]:v})},100),[h]),j=z(m),N=(0,w.useMemo)(()=>j.reduce((c,g)=>(y.PAN_ZOOM===g||y.isBinColoring(g)||c.push({signalName:g,handler:(v,Q)=>_(v,Q)}),c),[]),[j,_]),B=I(c=>{S.error(c),S.debug(p),d(c)}),J=I(c=>{S.debug("[Vega view] created",c),o.current=c,d(void 0)}),R=()=>{let c=[];return y.hasPoint(m)&&c.push(["Point selection","click to select a point; hold shift for multi-select"]),y.hasInterval(m)&&c.push(["Interval selection","click and drag to select an interval"]),y.hasLegend(m)&&c.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),y.hasPanZoom(m)&&c.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),c.length===0?null:(0,f.jsx)(ot,{delayDuration:300,side:"left",content:(0,f.jsx)("div",{className:"text-xs flex flex-col",children:c.map((g,v)=>(0,f.jsxs)("div",{children:[(0,f.jsxs)("span",{className:"font-bold tracking-wide",children:[g[0],":"]})," ",g[1]]},v))}),children:(0,f.jsx)(it,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})},x=mt({ref:l,spec:p,options:{theme:i==="dark"?"dark":void 0,actions:Mt,mode:"vega-lite",tooltip:rt.call,renderer:"canvas"},onError:B,onEmbed:J});return(0,w.useEffect)(()=>(N.forEach(({signalName:c,handler:g})=>{try{x==null||x.view.addSignalListener(c,g)}catch(v){S.error(v)}}),()=>{N.forEach(({signalName:c,handler:g})=>{try{x==null||x.view.removeSignalListener(c,g)}catch(v){S.error(v)}})}),[x,N]),(0,f.jsxs)(f.Fragment,{children:[s&&(0,f.jsxs)(ut,{variant:"destructive",children:[(0,f.jsx)(pt,{children:s.message}),(0,f.jsx)("div",{className:"text-md",children:s.stack})]}),(0,f.jsxs)("div",{className:"relative",onPointerDown:nt.stopPropagation(),children:[(0,f.jsx)("div",{ref:l}),R()]})]})},Mt={source:!1,compiled:!1};function Ot(t){return t instanceof Set?[...t]:t}function Nt(t){return Array.isArray(t)?t.map(r=>r instanceof Date&&lt(r)?new Date(r).getTime():r):t}var Pt=_t;export{Pt as default};
