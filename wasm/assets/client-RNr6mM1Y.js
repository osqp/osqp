var W=Object.defineProperty;var B=(t,e,n)=>e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var m=(t,e,n)=>B(t,typeof e!="symbol"?e+"":e,n);var g;import{s as x}from"./chunk-DZLz74EQ.js";import{o as D}from"./react-7g8sREeT.js";import{An as s,Dn as b,Fn as P,Mn as G,Tn as K,U as z,cn as R,dn as j,fn as J,jn as f,ln as Q,nr as k,pn as X,tr as v,un as Y,wn as Z,wr as ee}from"./cells-Dd1FatlG.js";import{x as te}from"./_Uint8Array-CPNtPV0k.js";import{t as ne}from"./debounce-Bzqd6azt.js";import{a as re,r as w,t as I}from"./invariant-91cSKJcr.js";import{t as i}from"./Logger-BkkOJyg0.js";import{d as ae,g as E}from"./utils-DBmmAf_K.js";import{r as oe}from"./config-DXGmIv9f.js";import{Rt as S,_t as u,et as ie,rt as M}from"./dist-CoL9j4yJ.js";import{D as T,O,g as se,w as le}from"./dist-Cs8TISgf.js";import{n as p}from"./once-8ZDiGGtA.js";import{r as ce}from"./key-D4QiH_7H.js";import{t as me}from"./use-toast-D6NNsC80.js";import{a as ue}from"./connection-D2GvycR9.js";import{r as de}from"./useNonce-BbWkd3B4.js";var ge="Expected a function";function pe(t,e,n){var a=!0,o=!0;if(typeof t!="function")throw TypeError(ge);return te(n)&&(a="leading"in n?!!n.leading:a,o="trailing"in n?!!n.trailing:o),ne(t,e,{leading:a,maxWait:e,trailing:o})}var he=pe;function fe(t){"scheduler"in window?window.scheduler.postTask(t,{priority:"background"}):"requestIdleCallback"in window?requestIdleCallback(t):setTimeout(t,0)}var C=null,ve=class{constructor(t){m(this,"abortController",new AbortController);this.view=t.view,this.view.dom.addEventListener("focus",()=>{C=new WeakRef(this.view)},{signal:this.abortController.signal,capture:!0}),this.update()}update(){let t=this.view.dom.querySelector(".cm-vimCursorLayer");if(t instanceof HTMLElement)if(z())t.style.display="none";else{let e=(C==null?void 0:C.deref())===this.view;t.style.display=e?"":"none"}}destroy(){this.abortController.abort()}};const $={map:{args:["lhs","rhs"]},nmap:{mode:"normal",args:["lhs","rhs"]},vmap:{mode:"visual",args:["lhs","rhs"]},imap:{mode:"insert",args:["lhs","rhs"]},noremap:{args:["lhs","rhs"]},nnoremap:{mode:"normal",args:["lhs","rhs"]},vnoremap:{mode:"visual",args:["lhs","rhs"]},inoremap:{mode:"insert",args:["lhs","rhs"]},unmap:{args:["lhs"]},nunmap:{mode:"normal",args:["lhs"]},vunmap:{mode:"visual",args:["lhs"]},iunmap:{mode:"insert",args:["lhs"]},mapclear:{},nmapclear:{mode:"normal"},vmapclear:{mode:"visual"},imapclear:{mode:"insert"}};function we(t,e){let n=[];for(let a of t.split(`
`)){if(a.startsWith('"')||a.trim()==="")continue;let o=Ce(a,e);o&&n.push(o)}return n}function Ce(t,e){let n=t.split(/\s+/),a=n[0],o=0;if(a in $){let r=$[a],d={};for(let h of r.args||[])if(o+=1,o<n.length)d[h]=n[o];else{e&&e(`Not enough arguments for "${a}" command: "${t}"`);return}let c={name:a};return"args"in r&&(c.args=d),"mode"in r&&(c.mode=r.mode),c}e&&e(`Unknown vimrc command: "${t}"`)}function ye(){return xe(),Ie(),[u.of([{key:"j",run:t=>{if(Z(t,!0)&&b(t)){let e=t.state.facet(v),n=t.state.facet(k);return e.moveToNextCell({cellId:n,before:!1,noCreate:!0}),!0}return!1}}]),u.of([{key:"k",run:t=>{if(K(t)&&b(t)){let e=t.state.facet(v),n=t.state.facet(k);return e.moveToNextCell({cellId:n,before:!0,noCreate:!0}),!0}return!1}}]),u.of([{linux:"Ctrl-[",win:"Ctrl-[",run:t=>{let e=f(t);return e?F(e)?e.state.vim.insertMode?(s.exitInsertMode(e,!0),!0):!1:(i.warn("Expected CodeMirror instance to have Vim state"),!1):(i.warn("Expected CodeMirror instance to have CodeMirror instance state"),!1)}}]),M.define(t=>(requestAnimationFrame(()=>{q.INSTANCES.addInstance(t)}),{destroy(){q.INSTANCES.removeInstance(t)}})),M.define(t=>new ve({view:t})),ie.domEventHandlers({keydown(t,e){return t.ctrlKey&&t.key==="Escape"?(e.dom.dispatchEvent(new KeyboardEvent(t.type,t)),!0):!1}})]}var xe=p(()=>{s.defineAction("goToDefinition",t=>{let e=t.cm6;return P(e)}),s.mapCommand("gd","action","goToDefinition",{},{context:"normal"}),s.defineEx("write","w",t=>{let e=t.cm6;e&&e.state.facet(v).saveNotebook()})}),Ie=p(async()=>{var e;let t=(e=w.get(E).keymap)==null?void 0:e.vimrc;if(t)try{i.log(`Loading vimrc from ${t}`);let n=(await ce().sendFileDetails({path:t})).contents;if(!n){i.error(`Failed to load vimrc from ${t}`);return}let a=we(n,i.warn);De(a)}catch(n){i.error("Failed to load vimrc:",n)}});function De(t){function e(r){if(!r.args){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}if(!r.args.lhs||!r.args.rhs){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}r.mode?s.map(r.args.lhs,r.args.rhs,r.mode):s.map(r.args.lhs,r.args.rhs)}function n(r){if(!r.args){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}if(!r.args.lhs||!r.args.rhs){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}r.mode?s.noremap(r.args.lhs,r.args.rhs,r.mode):s.noremap(r.args.lhs,r.args.rhs)}function a(r){if(!r.args){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}if(!r.args.lhs){i.warn(`Could not execute vimrc command "${r.name}: expected arguments"`);return}r.mode?s.unmap(r.args.lhs,r.mode):s.unmap(r.args.lhs)}function o(r){r.mode?s.mapclear(r.mode):s.mapclear()}for(let r of t)"map|nmap|vmap|imap".split("|").includes(r.name)?e(r):"noremap|nnoremap|vnoremap|inoremap".split("|").includes(r.name)?n(r):"unmap|nunmap|vunmap|iunmap".split("|").includes(r.name)?a(r):"mapclear|nmapclear|vmapclear|imapclear".split("|").includes(r.name)?o(r):i.warn(`Could not execute vimrc command "${r.name}: unknown command"`)}var q=(g=class{constructor(){m(this,"instances",new Set);m(this,"isBroadcasting",!1)}addInstance(e){this.instances.add(e);let n=f(e);if(!n){i.warn("Expected CodeMirror instance to have CodeMirror instance state");return}n.on("vim-mode-change",a=>{this.isBroadcasting||(I("mode"in a,'Expected event to have a "mode" property'),this.isBroadcasting=!0,fe(()=>{this.broadcastModeChange(e,a.mode,a.subMode),this.isBroadcasting=!1}))})}removeInstance(e){this.instances.delete(e)}broadcastModeChange(e,n,a){I("exitInsertMode"in s,"Vim does not have an exitInsertMode method"),I("exitVisualMode"in s,"Vim does not have an exitVisualMode method");for(let o of this.instances)if(o!==e){let r=f(o);if(!r){i.warn("Expected CodeMirror instance to have CodeMirror instance state");continue}let d=r.setSelections.bind(r);if(r.setSelections=()=>[],!F(r)){i.warn("Expected CodeMirror instance to have Vim state");continue}let c=r.state.vim;switch(n){case"normal":c.insertMode&&s.exitInsertMode(r,!0),c.visualMode&&s.exitVisualMode(r,!0);break;case"insert":c.insertMode||s.handleKey(r,"i","");break;case"visual":break}r.setSelections=d}}},m(g,"INSTANCES",new g),g);function F(t){return t.state.vim!==void 0}const be=["default","vim"];function ke(t,e){switch(t.preset){case"default":return[u.of(V()),u.of(_(e))];case"vim":return[u.of(Se()),u.of(_(e)),u.of([{key:"Enter",run:n=>{var a,o;return(o=(a=f(n))==null?void 0:a.state.vim)!=null&&o.insertMode?le(n):!1}}]),S.high(Me("d",n=>n.state.doc.toString()==="",n=>n.state.doc.toString()===""?(n.state.facet(v).deleteCell(),!0):!1)),G({status:!1}),S.high(ye())];default:return de(t.preset),[]}}var Ee=new Set([O,T]),V=p(()=>se.filter(t=>!Ee.has(t.run))),_=t=>[{key:t.getHotkey("cell.toggleComment").key,run:O},{key:t.getHotkey("cell.toggleBlockComment").key,run:T}],Se=p(()=>{let t=new Set(["Enter","Ctrl-v"]);return V().filter(e=>!t.has(e.key||e.mac||e.linux||e.win||""))});function Me(t,e,n){let a="",o=0;return u.of([{any:(r,d)=>{let c=d.key,h=d.timeStamp;return c!==t||!e(r)?(a="",o=0,!1):a===t&&h-o<500&&n(r)?(a="",o=0,!0):(a=c,o=h,!1)}}])}var A="marimo:copilot:signedIn";const Te=ee(A,null,void 0,{getOnInit:!0}),Oe=D(null),y=D(null);function $e(t){w.set(y,t)}function qe(t){w.get(y)===t&&w.set(y,null)}function Fe(){return localStorage.getItem(A)==="true"}function H(){let t=Fe(),e=ae();return t&&e.completion.copilot==="github"}function Ve(){return re(E,t=>t.completion.copilot==="github")}var _e=x(j()),l=i.get("@github/copilot-language-server"),Ae=class extends Q{constructor(){super(...arguments);m(this,"documentVersion",0);m(this,"hasOpenedDocument",!1);m(this,"getCompletionInternal",async(e,n)=>await this._request("textDocument/inlineCompletion",{...e,textDocument:{...e.textDocument,version:n}}));m(this,"throttledGetCompletionInternal",he(this.getCompletionInternal,200))}async _request(e,n){try{return await this.request(e,n)}catch(a){throw l.error("#request: Error",a),a}}async notify(e,n){return l.debug("#notify",e,n),super.notify(e,n)}getInitializationOptions(){let e={name:"marimo",version:"0.1.0"};return{...super.getInitializationOptions(),workspaceFolders:[],capabilities:{workspace:{workspaceFolders:!1}},initializationOptions:{editorInfo:e,editorPluginInfo:e}}}isDisabled(){return!H()}async textDocumentDidOpen(e){return this.isDisabled()?e:(this.hasOpenedDocument=!0,super.textDocumentDidOpen(e))}async textDocumentCompletion(e){return[]}async textDocumentDidChange(e){if(this.isDisabled())return e;this.hasOpenedDocument||await this.textDocumentDidOpen({textDocument:{uri:e.textDocument.uri,languageId:"python",version:e.textDocument.version,text:e.contentChanges[0].text}});let n=e.contentChanges;n.length!==1&&l.warn("#textDocumentDidChange: Multiple changes detected. This is not supported.",n);let a=n[0];"range"in a&&l.warn("#textDocumentDidChange: Copilot doesn't support range changes.",a);let o=R(a.text);return super.textDocumentDidChange({...e,contentChanges:[{text:o}],textDocument:_e.VersionedTextDocumentIdentifier.create(e.textDocument.uri,++this.documentVersion)})}textDocumentHover(e){return Promise.resolve({contents:[]})}signOut(){return this._request("signOut",{})}async signInInitiate(){l.log("#signInInitiate: Starting sign-in flow");try{let e=await this._request("signIn",{});return l.log("#signInInitiate: Sign-in flow started successfully"),e}catch(e){throw l.warn("#signInInitiate: Failed to start sign-in flow",e),e}}async signInConfirm(e){l.log("#signInConfirm: Confirming sign-in");try{let n=await this._request("signInConfirm",e);return l.log("#signInConfirm: Sign-in confirmed successfully"),n}catch(n){throw l.warn("#signInConfirm: Failed to confirm sign-in",n),n}}async signedIn(){try{let{status:e}=await this._request("checkStatus",{});return l.log("#checkStatus: Status check completed",{status:e}),e==="SignedIn"||e==="AlreadySignedIn"||e==="OK"}catch(e){throw l.warn("#signedIn: Failed to check sign-in status",e),e}}async getCompletion(e){if(this.isDisabled())return null;let n=this.documentVersion;if(e.textDocument.version=n,n===0)return null;$e(n);let a=await this.throttledGetCompletionInternal(e,n);return qe(n),n===this.documentVersion?a??null:null}},He=x(J()),Ne=x(X());const N="/__marimo_copilot__.py";var U=`file://${N}`;const Ue=p(()=>new Le);var Le=class extends Ne.Transport{constructor(){super(),this.delegate=void 0}getWsUrl(){return oe().getLSPURL("copilot").toString()}async tryConnect(t=3,e=1e3){for(let n=1;n<=t;n++)try{this.delegate||(this.delegate=new He.WebSocketTransport(this.getWsUrl())),await this.delegate.connect(),i.log("Copilot#connect: Connected successfully");return}catch(a){if(i.warn(`Copilot#connect: Connection attempt ${n}/${t} failed`,a),n===t)throw this.delegate=void 0,me({variant:"danger",title:"GitHub Copilot Connection Error",description:"Failed to connect to GitHub Copilot. Please check settings and try again."}),a;await new Promise(o=>setTimeout(o,e))}}async connect(){return await Ve(),await ue(),this.tryConnect()}close(){var t;(t=this.delegate)==null||t.close(),this.delegate=void 0}async sendData(t,e){var n;return e=Math.min(e??5e3,5e3),(n=this.delegate)==null?void 0:n.sendData(t,e)}};const L=p(()=>new Ae({rootUri:U,workspaceFolders:null,transport:Ue()}));function We(){return Y({documentUri:U,client:L(),languageId:"copilot",hoverEnabled:!1,completionEnabled:!1,definitionEnabled:!1,renameEnabled:!1,codeActionsEnabled:!1,signatureHelpEnabled:!1,diagnosticsEnabled:!1,sendIncrementalChanges:!1})}export{y as a,be as c,Oe as i,ke as l,We as n,H as o,L as r,Te as s,N as t};
