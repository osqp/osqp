import{s as _}from"./chunk-DZLz74EQ.js";import"./react-7g8sREeT.js";import{t as F}from"./react-BcIddLXZ.js";import"./react-dom-D6bRRS5R.js";import"./zod-BEi78Y5d.js";import{n as E,t as G}from"./jsx-runtime-DvsdsEjx.js";import"./_Uint8Array-CPNtPV0k.js";import"./isSymbol-D1Vf4s0g.js";import"./toNumber-Bjr00yqN.js";import"./isArrayLikeObject-CQy5-FN4.js";import"./_getTag-C4fv2peH.js";import"./_baseIsEqual-Cdnsi4t8.js";import"./merge-DrdmtLTL.js";import"./now-CKgsywea.js";import{t as W}from"./debounce-Bzqd6azt.js";import"./invariant-91cSKJcr.js";import{n as C}from"./loader-CgbiPC_T.js";import{t as x}from"./Logger-BkkOJyg0.js";import{a as I}from"./hotkeys-CBY41Jr2.js";import"./utils-DBmmAf_K.js";import"./constants-Cv7-oioA.js";import{n as N}from"./config-DXGmIv9f.js";import"./dist-CLazWf1X.js";import"./cn-Dr9kMPPj.js";import"./dist-D-dnh2ed.js";import"./useEventListener-g9rPKvBX.js";import{t as $}from"./events-BGfCi1Xy.js";import"./button-Bxk0BtBn.js";import"./Deferred-Mppm0cvJ.js";import{r as q}from"./useTheme-oPMxEKRc.js";import"./createLucideIcon-QLW8E4z5.js";import{u as R}from"./toDate-Daj1hQSF.js";import"./namespace-CnoeT75h.js";import{t as B}from"./tooltip-ULHbIsj9.js";import"./fullscreen-DTPr3iBY.js";import"./tslib.es6-dlz5WbC8.js";import{t as J}from"./isValid-o3nZVu8e.js";import"./alert-dialog-BO8sf-73.js";import{n as O}from"./useEvent-BOb1a9d1.js";import"./errors-_3XAtRr3.js";import{n as U}from"./vega-loader.browser.module-BkWiTok0.js";import"./precisionRound-TxjBk8nN.js";import"./linear-nWRf49aw.js";import{r as c}from"./src-KuQao6GK.js";import"./ordinal-CHS6rGcb.js";import"./time-BkIHCvH2.js";import"./range-BPiwmiGf.js";import"./defaultLocale-DPsgYaXf.js";import"./defaultLocale-C6TNIE_k.js";import"./prop-types-CHKlDUlJ.js";import{r as X,t as Y}from"./alert-hjKHAeOD.js";import{n as Q}from"./useAsyncData-D9GA9BWg.js";import"./dist-DcASoeRZ.js";import{t as A}from"./useDeepCompareMemoize-BsZY8i2r.js";import{n as tt}from"./error-banner-BGjnZePp.js";import"./fast-deep-equal-BdzBWnNx.js";import{t as et}from"./formats-CWdWXhfT.js";import"./timer-m_pEB4Lb.js";import"./path-Gc-fQZTe.js";import"./math-BsaXoFIn.js";import"./arc-De5rudRM.js";import"./array-DZFD9yN1.js";import"./step-aJ-oEw6-.js";import"./line-1VYCafWO.js";import"./init-BEfLCoUT.js";import"./colors-BlRVeShK.js";import"./treemap-CMOdyZ8L.js";import{n as rt}from"./esm-BBn_y9Ew.js";var nt=_(E()),k=_(F());function at(t){return t.data&&"url"in t.data&&(t.data.url=N(t.data.url).href),t}var K=new Set(["boxplot","errorband","errorbar"]);const g={getMarkType(t){let e=typeof t=="string"?t:t.type;if(K.has(e))throw Error("Not supported");return e},isInteractive(t){let e=typeof t=="string"?t:t.type;return!K.has(e)},makeClickable(t){let e=typeof t=="string"?t:t.type;return e in c?typeof t=="string"?{type:t,cursor:"pointer",tooltip:!0}:{...t,type:e,cursor:"pointer",tooltip:!0}:t},getOpacity(t){return typeof t=="string"?null:"opacity"in t&&typeof t.opacity=="number"?t.opacity:null}};function it(t){if(!t||!("encoding"in t))return[];let{encoding:e}=t;return e?Object.entries(e).flatMap(n=>{let[a,r]=n;return!r||!ot.has(a)?[]:"field"in r&&typeof r.field=="string"?[r.field]:"condition"in r&&r.condition&&typeof r.condition=="object"&&"field"in r.condition&&r.condition.field&&typeof r.condition.field=="string"?[r.condition.field]:[]}):[]}var ot=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function st(t,e,n,a){let r={and:n.map(o=>({param:o}))};switch(t){case"opacity":{let o=g.getOpacity(a)||1;return{...e,opacity:{condition:{test:r,value:o},value:o/5}}}default:return e}}const h={point(t){return t==null?"select_point":`select_point_${t}`},interval(t){return t==null?"select_interval":`select_interval_${t}`},legendSelection(t){return`legend_selection_${t}`},HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint(t){return t.some(e=>e.startsWith("select_point"))},hasInterval(t){return t.some(e=>e.startsWith("select_interval"))},hasLegend(t){return t.some(e=>e.startsWith("legend_selection"))},hasPanZoom(t){return t.some(e=>e.startsWith("pan_zoom"))}},b={highlight(){return{name:h.HIGHLIGHT,select:{type:"point",on:"mouseover"}}},interval(t,e){return{name:h.interval(e),select:{type:"interval",encodings:V(t),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}},point(t,e){return{name:h.point(e),select:{type:"point",encodings:V(t),on:"click[!event.metaKey]"}}},legend(t){return{name:h.legendSelection(t),select:{type:"point",fields:[t]},bind:"legend"}},panZoom(){return{name:h.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}}}};function V(t){switch(g.getMarkType(t.mark)){case c.image:case c.trail:return;case c.area:case c.arc:return["color"];case c.bar:{let e=lt(t);return e==="horizontal"?["y"]:e==="vertical"?["x"]:void 0}case c.circle:case c.geoshape:case c.line:case c.point:case c.rect:case c.rule:case c.square:case c.text:case c.tick:return["x","y"]}}function T(t){return"params"in t&&t.params&&t.params.length>0?t.params.filter(e=>e==null?!1:"select"in e&&e.select!==void 0).map(e=>e.name):"layer"in t?[...new Set(t.layer.flatMap(T))]:[]}function lt(t){var a,r;if(!t||!("mark"in t))return;let e=(a=t.encoding)==null?void 0:a.x,n=(r=t.encoding)==null?void 0:r.y;if(e&&"type"in e&&e.type==="nominal")return"vertical";if(n&&"type"in n&&n.type==="nominal"||e&&"aggregate"in e)return"horizontal";if(n&&"aggregate"in n)return"vertical"}function mt(t,e){var o,u;let{chartSelection:n=!0,fieldSelection:a=!0}=e;if(!n&&!a)return t;if((o=t.params)!=null&&o.some(i=>i.bind==="legend")&&(a=!1),(u=t.params)!=null&&u.some(i=>!i.bind)&&(n=!1),"vconcat"in t){let i=t.vconcat.map(s=>"mark"in s?S(s):s);return{...t,vconcat:i}}if("hconcat"in t){let i=t.hconcat.map(s=>"mark"in s?S(s):s);return{...t,hconcat:i}}if("layer"in t){let i=t.layer.map((s,d)=>{if(!("mark"in s))return s;let l=s;return l=Z(l,n,d),l=S(l),d===0&&(l=z(l)),l});return{...t,layer:i}}if(!("mark"in t)||!g.isInteractive(t.mark))return t;let r=t;return r=ct(r,a),r=Z(r,n,void 0),r=S(r),r=z(r),r}function ct(t,e){if(e===!1)return t;let n=it(t);Array.isArray(e)&&(n=n.filter(o=>e.includes(o)));let a=n.map(o=>b.legend(o)),r=[...t.params||[],...a];return{...t,params:r}}function Z(t,e,n){if(e===!1)return t;let a;try{a=g.getMarkType(t.mark)}catch{return t}if(a==="geoshape")return t;let r=e===!0?pt(a):[e];if(!r)return t;let o=r.map(i=>i==="interval"?b.interval(t,n):b.point(t,n)),u=[...t.params||[],...o];return{...t,params:u}}function z(t){let e;try{e=g.getMarkType(t.mark)}catch{}if(e==="geoshape")return t;let n=t.params||[];return n.some(a=>a.bind==="scales")?t:{...t,params:[...n,b.panZoom()]}}function S(t){let e="encoding"in t?t.encoding:void 0,n=t.params||[],a=n.map(r=>r.name);return n.length===0||!g.isInteractive(t.mark)?t:{...t,mark:g.makeClickable(t.mark),encoding:st("opacity",e||{},a,t.mark)}}function pt(t){switch(t){case"arc":case"area":return["point"];case"text":case"bar":return["point","interval"];case"line":return;default:return["point","interval"]}}async function ut(t){if(!t)return t;let e="datasets"in t?{...t.datasets}:{},n=async r=>{if(!r)return r;if("layer"in r){let i=await Promise.all(r.layer.map(n));r={...r,layer:i}}if("hconcat"in r){let i=await Promise.all(r.hconcat.map(n));r={...r,hconcat:i}}if("vconcat"in r){let i=await Promise.all(r.vconcat.map(n));r={...r,vconcat:i}}if("spec"in r&&(r={...r,spec:await n(r.spec)}),!r.data||!("url"in r.data))return r;let o;try{o=N(r.data.url)}catch{return r}let u=await C(o.href,r.data.format);return e[o.pathname]=u,{...r,data:{name:o.pathname}}},a=await n(t);return Object.keys(e).length===0?a:{...a,datasets:e}}var p=_(G());U("arrow",et);var dt=t=>{let e=(0,nt.c)(11),{value:n,setValue:a,chartSelection:r,fieldSelection:o,spec:u}=t,i,s;e[0]===u?(i=e[1],s=e[2]):(i=async()=>ut(u),s=[u],e[0]=u,e[1]=i,e[2]=s);let{data:d,error:l}=Q(i,s);if(l){let y;return e[3]===l?y=e[4]:(y=(0,p.jsx)(tt,{error:l}),e[3]=l,e[4]=y),y}if(!d)return null;let f;return e[5]!==r||e[6]!==o||e[7]!==d||e[8]!==a||e[9]!==n?(f=(0,p.jsx)(ft,{value:n,setValue:a,chartSelection:r,fieldSelection:o,spec:d}),e[5]=r,e[6]=o,e[7]=d,e[8]=a,e[9]=n,e[10]=f):f=e[10],f},ft=({value:t,setValue:e,chartSelection:n,fieldSelection:a,spec:r})=>{let{theme:o}=q(),u=(0,k.useRef)(void 0),[i,s]=(0,k.useState)(),d=A(r),l=(0,k.useMemo)(()=>mt(at(d),{chartSelection:n,fieldSelection:a}),[d,n,a]),f=(0,k.useMemo)(()=>T(l),[l]),y=O(m=>{e({...t,...m})}),P=A(f),H=(0,k.useMemo)(()=>P.reduce((m,v)=>(h.PAN_ZOOM===v||(m[v]=W((w,M)=>{x.debug("[Vega signal]",w,M);let j=I.mapValues(M,gt);j=I.mapValues(j,yt),y({[w]:j})},100)),m),{}),[P,y]),L=O(m=>{x.error(m),x.debug(l),s(m)}),D=O(m=>{x.debug("[Vega view] created",m),u.current=m,s(void 0)});return(0,p.jsxs)(p.Fragment,{children:[i&&(0,p.jsxs)(Y,{variant:"destructive",children:[(0,p.jsx)(X,{children:i.message}),(0,p.jsx)("div",{className:"text-md",children:i.stack})]}),(0,p.jsxs)("div",{className:"relative",onPointerDown:$.stopPropagation(),children:[(0,p.jsx)(rt,{spec:l,theme:o==="dark"?"dark":void 0,actions:ht,signalListeners:H,onError:L,onNewView:D}),(()=>{let m=[];return h.hasPoint(f)&&m.push(["Point selection","click to select a point; hold shift for multi-select"]),h.hasInterval(f)&&m.push(["Interval selection","click and drag to select an interval"]),h.hasLegend(f)&&m.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),h.hasPanZoom(f)&&m.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),m.length===0?null:(0,p.jsx)(B,{delayDuration:300,side:"left",content:(0,p.jsx)("div",{className:"text-xs flex flex-col",children:m.map((v,w)=>(0,p.jsxs)("div",{children:[(0,p.jsxs)("span",{className:"font-bold tracking-wide",children:[v[0],":"]})," ",v[1]]},w))}),children:(0,p.jsx)(R,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})})()]})]})},ht={source:!1,compiled:!1};function yt(t){return t instanceof Set?[...t]:t}function gt(t){return Array.isArray(t)?t.map(e=>e instanceof Date&&J(e)?new Date(e).getTime():e):t}var vt=dt;export{vt as default};
