var st=Object.defineProperty;var at=(t,e,h)=>e in t?st(t,e,{enumerable:!0,configurable:!0,writable:!0,value:h}):t[e]=h;var N=(t,e,h)=>at(t,typeof e!="symbol"?e+"":e,h);import{s as ht,t as P}from"./chunk-DZLz74EQ.js";import{c as ut,d as V,n as ct}from"./jotai-BTnrNcC1.js";import{u as j}from"./hotkeys-ClCtr3_I.js";import{t as lt}from"./invariant-D5a0EE05.js";import{t as ft}from"./utils-DEDX0RLo.js";import{n as F}from"./constants-CEISdYm1.js";import{t as dt}from"./Deferred-NfAvvkGM.js";function z(){return typeof document<"u"&&document.querySelector("marimo-wasm")!==null}function q(){return(window==null?void 0:window.__MARIMO_STATIC__)!==void 0}function pt(){return lt(window.__MARIMO_STATIC__!==void 0,"Not a static notebook"),window.__MARIMO_STATIC__.files}var gt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.toBig=t.shrSL=t.shrSH=t.rotrSL=t.rotrSH=t.rotrBL=t.rotrBH=t.rotr32L=t.rotr32H=t.rotlSL=t.rotlSH=t.rotlBL=t.rotlBH=t.add5L=t.add5H=t.add4L=t.add4H=t.add3L=t.add3H=void 0,t.add=b,t.fromBig=w,t.split=f;var e=BigInt(2**32-1),h=BigInt(32);function w(o,i=!1){return i?{h:Number(o&e),l:Number(o>>h&e)}:{h:Number(o>>h&e)|0,l:Number(o&e)|0}}function f(o,i=!1){let n=o.length,l=new Uint32Array(n),k=new Uint32Array(n);for(let S=0;S<n;S++){let{h:H,l:W}=w(o[S],i);[l[S],k[S]]=[H,W]}return[l,k]}var U=(o,i)=>BigInt(o>>>0)<<h|BigInt(i>>>0);t.toBig=U;var _=(o,i,n)=>o>>>n;t.shrSH=_;var E=(o,i,n)=>o<<32-n|i>>>n;t.shrSL=E;var C=(o,i,n)=>o>>>n|i<<32-n;t.rotrSH=C;var T=(o,i,n)=>o<<32-n|i>>>n;t.rotrSL=T;var I=(o,i,n)=>o<<64-n|i>>>n-32;t.rotrBH=I;var R=(o,i,n)=>o>>>n-32|i<<64-n;t.rotrBL=R;var M=(o,i)=>i;t.rotr32H=M;var $=(o,i)=>o;t.rotr32L=$;var O=(o,i,n)=>o<<n|i>>>32-n;t.rotlSH=O;var A=(o,i,n)=>i<<n|o>>>32-n;t.rotlSL=A;var p=(o,i,n)=>i<<n-32|o>>>64-n;t.rotlBH=p;var m=(o,i,n)=>o<<n-32|i>>>64-n;t.rotlBL=m;function b(o,i,n,l){let k=(i>>>0)+(l>>>0);return{h:o+n+(k/2**32|0)|0,l:k|0}}var g=(o,i,n)=>(o>>>0)+(i>>>0)+(n>>>0);t.add3L=g;var B=(o,i,n,l)=>i+n+l+(o/2**32|0)|0;t.add3H=B;var c=(o,i,n,l)=>(o>>>0)+(i>>>0)+(n>>>0)+(l>>>0);t.add4L=c;var s=(o,i,n,l,k)=>i+n+l+k+(o/2**32|0)|0;t.add4H=s;var u=(o,i,n,l,k)=>(o>>>0)+(i>>>0)+(n>>>0)+(l>>>0)+(k>>>0);t.add5L=u;var d=(o,i,n,l,k,S)=>i+n+l+k+S+(o/2**32|0)|0;t.add5H=d,t.default={fromBig:w,split:f,toBig:U,shrSH:_,shrSL:E,rotrSH:C,rotrSL:T,rotrBH:I,rotrBL:R,rotr32H:M,rotr32L:$,rotlSH:O,rotlSL:A,rotlBH:p,rotlBL:m,add:b,add3L:g,add3H:B,add4L:c,add4H:s,add5H:d,add5L:u}})),wt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.crypto=void 0,t.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0})),yt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.Hash=t.nextTick=t.swap32IfBE=t.byteSwapIfBE=t.swap8IfBE=t.isLE=void 0,t.isBytes=h,t.anumber=w,t.abytes=f,t.ahash=U,t.aexists=_,t.aoutput=E,t.u8=C,t.u32=T,t.clean=I,t.createView=R,t.rotr=M,t.rotl=$,t.byteSwap=O,t.byteSwap32=A,t.bytesToHex=b,t.hexToBytes=c,t.asyncLoop=s,t.utf8ToBytes=u,t.bytesToUtf8=d,t.toBytes=o,t.kdfInputToBytes=i,t.concatBytes=n,t.checkOpts=l,t.createHasher=k,t.createOptHasher=S,t.createXOFer=H,t.randomBytes=W;var e=wt();function h(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function w(r){if(!Number.isSafeInteger(r)||r<0)throw Error("positive integer expected, got "+r)}function f(r,...a){if(!h(r))throw Error("Uint8Array expected");if(a.length>0&&!a.includes(r.length))throw Error("Uint8Array expected of length "+a+", got length="+r.length)}function U(r){if(typeof r!="function"||typeof r.create!="function")throw Error("Hash should be wrapped by utils.createHasher");w(r.outputLen),w(r.blockLen)}function _(r,a=!0){if(r.destroyed)throw Error("Hash instance has been destroyed");if(a&&r.finished)throw Error("Hash#digest() has already been called")}function E(r,a){f(r);let y=a.outputLen;if(r.length<y)throw Error("digestInto() expects output buffer of length at least "+y)}function C(r){return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}function T(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function I(...r){for(let a=0;a<r.length;a++)r[a].fill(0)}function R(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function M(r,a){return r<<32-a|r>>>a}function $(r,a){return r<<a|r>>>32-a>>>0}t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function O(r){return r<<24&4278190080|r<<8&16711680|r>>>8&65280|r>>>24&255}t.swap8IfBE=t.isLE?r=>r:r=>O(r),t.byteSwapIfBE=t.swap8IfBE;function A(r){for(let a=0;a<r.length;a++)r[a]=O(r[a]);return r}t.swap32IfBE=t.isLE?r=>r:A;var p=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",m=Array.from({length:256},(r,a)=>a.toString(16).padStart(2,"0"));function b(r){if(f(r),p)return r.toHex();let a="";for(let y=0;y<r.length;y++)a+=m[r[y]];return a}var g={_0:48,_9:57,A:65,F:70,a:97,f:102};function B(r){if(r>=g._0&&r<=g._9)return r-g._0;if(r>=g.A&&r<=g.F)return r-(g.A-10);if(r>=g.a&&r<=g.f)return r-(g.a-10)}function c(r){if(typeof r!="string")throw Error("hex string expected, got "+typeof r);if(p)return Uint8Array.fromHex(r);let a=r.length,y=a/2;if(a%2)throw Error("hex string expected, got unpadded hex of length "+a);let L=new Uint8Array(y);for(let v=0,x=0;v<y;v++,x+=2){let D=B(r.charCodeAt(x)),X=B(r.charCodeAt(x+1));if(D===void 0||X===void 0){let it=r[x]+r[x+1];throw Error('hex string expected, got non-hex character "'+it+'" at index '+x)}L[v]=D*16+X}return L}t.nextTick=async()=>{};async function s(r,a,y){let L=Date.now();for(let v=0;v<r;v++){y(v);let x=Date.now()-L;x>=0&&x<a||(await(0,t.nextTick)(),L+=x)}}function u(r){if(typeof r!="string")throw Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function d(r){return new TextDecoder().decode(r)}function o(r){return typeof r=="string"&&(r=u(r)),f(r),r}function i(r){return typeof r=="string"&&(r=u(r)),f(r),r}function n(...r){let a=0;for(let L=0;L<r.length;L++){let v=r[L];f(v),a+=v.length}let y=new Uint8Array(a);for(let L=0,v=0;L<r.length;L++){let x=r[L];y.set(x,v),v+=x.length}return y}function l(r,a){if(a!==void 0&&{}.toString.call(a)!=="[object Object]")throw Error("options should be object or undefined");return Object.assign(r,a)}t.Hash=class{};function k(r){let a=L=>r().update(o(L)).digest(),y=r();return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=()=>r(),a}function S(r){let a=(L,v)=>r(v).update(o(L)).digest(),y=r({});return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=L=>r(L),a}function H(r){let a=(L,v)=>r(v).update(o(L)).digest(),y=r({});return a.outputLen=y.outputLen,a.blockLen=y.blockLen,a.create=L=>r(L),a}t.wrapConstructor=k,t.wrapConstructorWithOpts=S,t.wrapXOFConstructorWithOpts=H;function W(r=32){if(e.crypto&&typeof e.crypto.getRandomValues=="function")return e.crypto.getRandomValues(new Uint8Array(r));if(e.crypto&&typeof e.crypto.randomBytes=="function")return Uint8Array.from(e.crypto.randomBytes(r));throw Error("crypto.getRandomValues must be defined")}})),Lt=P((t=>{Object.defineProperty(t,"__esModule",{value:!0}),t.shake256=t.shake128=t.keccak_512=t.keccak_384=t.keccak_256=t.keccak_224=t.sha3_512=t.sha3_384=t.sha3_256=t.sha3_224=t.Keccak=void 0,t.keccakP=m;var e=gt(),h=yt(),w=BigInt(0),f=BigInt(1),U=BigInt(2),_=BigInt(7),E=BigInt(256),C=BigInt(113),T=[],I=[],R=[];for(let c=0,s=f,u=1,d=0;c<24;c++){[u,d]=[d,(2*u+3*d)%5],T.push(2*(5*d+u)),I.push((c+1)*(c+2)/2%64);let o=w;for(let i=0;i<7;i++)s=(s<<f^(s>>_)*C)%E,s&U&&(o^=f<<(f<<BigInt(i))-f);R.push(o)}var M=(0,e.split)(R,!0),$=M[0],O=M[1],A=(c,s,u)=>u>32?(0,e.rotlBH)(c,s,u):(0,e.rotlSH)(c,s,u),p=(c,s,u)=>u>32?(0,e.rotlBL)(c,s,u):(0,e.rotlSL)(c,s,u);function m(c,s=24){let u=new Uint32Array(10);for(let d=24-s;d<24;d++){for(let n=0;n<10;n++)u[n]=c[n]^c[n+10]^c[n+20]^c[n+30]^c[n+40];for(let n=0;n<10;n+=2){let l=(n+8)%10,k=(n+2)%10,S=u[k],H=u[k+1],W=A(S,H,1)^u[l],r=p(S,H,1)^u[l+1];for(let a=0;a<50;a+=10)c[n+a]^=W,c[n+a+1]^=r}let o=c[2],i=c[3];for(let n=0;n<24;n++){let l=I[n],k=A(o,i,l),S=p(o,i,l),H=T[n];o=c[H],i=c[H+1],c[H]=k,c[H+1]=S}for(let n=0;n<50;n+=10){for(let l=0;l<10;l++)u[l]=c[n+l];for(let l=0;l<10;l++)c[n+l]^=~u[(l+2)%10]&u[(l+4)%10]}c[0]^=$[d],c[1]^=O[d]}(0,h.clean)(u)}var b=class ot extends h.Hash{constructor(s,u,d,o=!1,i=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=s,this.suffix=u,this.outputLen=d,this.enableXOF=o,this.rounds=i,(0,h.anumber)(d),!(0<s&&s<200))throw Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=(0,h.u32)(this.state)}clone(){return this._cloneInto()}keccak(){(0,h.swap32IfBE)(this.state32),m(this.state32,this.rounds),(0,h.swap32IfBE)(this.state32),this.posOut=0,this.pos=0}update(s){(0,h.aexists)(this),s=(0,h.toBytes)(s),(0,h.abytes)(s);let{blockLen:u,state:d}=this,o=s.length;for(let i=0;i<o;){let n=Math.min(u-this.pos,o-i);for(let l=0;l<n;l++)d[this.pos++]^=s[i++];this.pos===u&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:s,suffix:u,pos:d,blockLen:o}=this;s[d]^=u,u&128&&d===o-1&&this.keccak(),s[o-1]^=128,this.keccak()}writeInto(s){(0,h.aexists)(this,!1),(0,h.abytes)(s),this.finish();let u=this.state,{blockLen:d}=this;for(let o=0,i=s.length;o<i;){this.posOut>=d&&this.keccak();let n=Math.min(d-this.posOut,i-o);s.set(u.subarray(this.posOut,this.posOut+n),o),this.posOut+=n,o+=n}return s}xofInto(s){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(s)}xof(s){return(0,h.anumber)(s),this.xofInto(new Uint8Array(s))}digestInto(s){if((0,h.aoutput)(s,this),this.finished)throw Error("digest() was already called");return this.writeInto(s),this.destroy(),s}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,(0,h.clean)(this.state)}_cloneInto(s){let{blockLen:u,suffix:d,outputLen:o,rounds:i,enableXOF:n}=this;return s||(s=new ot(u,d,o,n,i)),s.state32.set(this.state32),s.pos=this.pos,s.posOut=this.posOut,s.finished=this.finished,s.rounds=i,s.suffix=d,s.outputLen=o,s.enableXOF=n,s.destroyed=this.destroyed,s}};t.Keccak=b;var g=(c,s,u)=>(0,h.createHasher)(()=>new b(s,c,u));t.sha3_224=g(6,144,224/8),t.sha3_256=g(6,136,256/8),t.sha3_384=g(6,104,384/8),t.sha3_512=g(6,72,512/8),t.keccak_224=g(1,144,224/8),t.keccak_256=g(1,136,256/8),t.keccak_384=g(1,104,384/8),t.keccak_512=g(1,72,512/8);var B=(c,s,u)=>(0,h.createXOFer)((d={})=>new b(s,c,d.dkLen===void 0?u:d.dkLen,!0));t.shake128=B(31,168,128/8),t.shake256=B(31,136,256/8)})),mt=P(((t,e)=>{var{sha3_512:h}=Lt(),w=24,f=32,U=(p=4,m=Math.random)=>{let b="";for(;b.length<p;)b+=Math.floor(m()*36).toString(36);return b};function _(p){let m=0n;for(let b of p.values()){let g=BigInt(b);m=(m<<8n)+g}return m}var E=(p="")=>_(h(p)).toString(36).slice(1),C=Array.from({length:26},(p,m)=>String.fromCharCode(m+97)),T=p=>C[Math.floor(p()*C.length)],I=({globalObj:p=typeof global<"u"?global:typeof window<"u"?window:{},random:m=Math.random}={})=>{let b=Object.keys(p).toString();return E(b.length?b+U(f,m):U(f,m)).substring(0,f)},R=p=>()=>p++,M=476782367,$=({random:p=Math.random,counter:m=R(Math.floor(p()*M)),length:b=w,fingerprint:g=I({random:p})}={})=>function(){let B=T(p),c=Date.now().toString(36),s=m().toString(36);return`${B+E(`${c+U(b,p)+s+g}`).substring(1,b)}`},O=$(),A=(p,{minLength:m=2,maxLength:b=f}={})=>{let g=p.length,B=/^[0-9a-z]+$/;try{if(typeof p=="string"&&g>=m&&g<=b&&B.test(p))return!0}finally{}return!1};e.exports.getConstants=()=>({defaultLength:w,bigLength:f}),e.exports.init=$,e.exports.createId=O,e.exports.bufToBigInt=_,e.exports.createCounter=R,e.exports.createFingerprint=I,e.exports.isCuid=A})),K=P(((t,e)=>{var{createId:h,init:w,getConstants:f,isCuid:U}=mt();e.exports.createId=h,e.exports.init=w,e.exports.getConstants=f,e.exports.isCuid=U}));function G(t){return new URL(t,document.baseURI)}function J(t){let e=new URL(window.location.href);t(e.searchParams),window.history.replaceState({},"",e.toString())}function bt(t,e){if(typeof window>"u")return!1;let h=new URLSearchParams(window.location.search);return e===void 0?h.has(t):h.get(t)===e}function kt(){return G(`?file=${`__new__${Q()}`}`).toString()}var Ut=/^(https?:\/\/\S+)$/;function vt(t){return typeof t=="string"&&Ut.test(t)}var St=(0,ht(K(),1).init)({length:6});function Q(){return`s_${St()}`}function Y(t){return t?/^s_[\da-z]{6}$/.test(t):!1}var _t=(()=>{let t=new URL(window.location.href).searchParams.get(F.sessionId);return Y(t)?(J(e=>{e.has(F.kiosk)||e.delete(F.sessionId)}),j.debug("Connecting to existing session",{sessionId:t}),t):(j.debug("Starting a new session",{sessionId:t}),Q())})();function Z(){return _t}var xt=class{constructor(t,e=!1){N(this,"initialHealthyCheck",new dt);this.config=t,this.lazy=e;try{new URL(this.config.url)}catch(h){throw Error(`Invalid runtime URL: ${this.config.url}. ${h instanceof Error?h.message:"Unknown error"}`)}this.lazy||this.init()}get httpURL(){return new URL(this.config.url)}get isSameOrigin(){return this.httpURL.origin===window.location.origin}formatHttpURL(t,e,h=!0){t||(t="");let w=this.httpURL,f=new URLSearchParams(window.location.search);if(e)for(let[U,_]of e.entries())w.searchParams.set(U,_);for(let[U,_]of f.entries())h&&!Object.values(F).includes(U)||w.searchParams.set(U,_);return w.pathname=`${w.pathname.replace(/\/$/,"")}/${t.replace(/^\//,"")}`,w.hash="",w}formatWsURL(t,e){return Bt(this.formatHttpURL(t,e,!1).toString())}getWsURL(t){let e=new URL(this.config.url),h=new URLSearchParams(e.search);return new URLSearchParams(window.location.search).forEach((w,f)=>{h.has(f)||h.set(f,w)}),h.set(F.sessionId,t),this.formatWsURL("/ws",h)}getWsSyncURL(t){let e=new URL(this.config.url),h=new URLSearchParams(e.search);return new URLSearchParams(window.location.search).forEach((w,f)=>{h.has(f)||h.set(f,w)}),h.set(F.sessionId,t),this.formatWsURL("/ws_sync",h)}getTerminalWsURL(){return this.formatWsURL("/terminal/ws")}getLSPURL(t){if(t==="copilot"){let e=this.formatWsURL(`/lsp/${t}`);return e.search="",e}return this.formatWsURL(`/lsp/${t}`)}getAiURL(t){return this.formatHttpURL(`/api/ai/${t}`)}healthURL(){return this.formatHttpURL("/health")}async isHealthy(){if(z()||ft())return!0;try{let t=await fetch(this.healthURL().toString());if(t.redirected){let h=t.url.replace(/\/health$/,"");this.config.url=h}let e=t.ok;return e&&this.setDOMBaseUri(this.config.url),e}catch{return!1}}setDOMBaseUri(t){t=t.split("?",1)[0],t.endsWith("/")||(t+="/");let e=document.querySelector("base");e?e.setAttribute("href",t):(e=document.createElement("base"),e.setAttribute("href",t),document.head.append(e))}async init(t){let e=0;for(;!await this.isHealthy();){if(e>=25){j.error("Failed to connect after 25 retries"),this.initialHealthyCheck.reject(Error("Failed to connect after 25 retries"));return}if(!(t!=null&&t.disableRetryDelay)){let h=Math.min(100*1.2**e,2e3);await new Promise(w=>setTimeout(w,h))}e++}this.initialHealthyCheck.resolve()}async waitForHealthy(){return this.initialHealthyCheck.promise}headers(){let t={"Marimo-Session-Id":Z(),"Marimo-Server-Token":this.config.serverToken??"","x-runtime-url":this.httpURL.toString()};return this.config.authToken&&(t.Authorization=`Bearer ${this.config.authToken}`),t}};function Bt(t){if(!t.startsWith("http")){j.warn(`URL must start with http: ${t}`);let e=new URL(t);return e.protocol="ws",e}return new URL(t.replace(/^http/,"ws"))}function Ht(){let t=new URL(document.baseURI);return t.search="",t.hash="",t.toString()}const tt={url:Ht()},rt=V(tt);var nt=V(t=>new xt(t(rt),q()));function It(){return ut(nt)}function et(){return ct.get(nt)}function Rt(t){if(t.startsWith("http"))return new URL(t);let e=et().httpURL.toString();return e.startsWith("blob:")&&(e=e.replace("blob:","")),new URL(t,e)}export{It as a,bt as c,J as d,G as f,z as g,q as h,rt as i,vt as l,pt as m,Rt as n,Z as o,K as p,et as r,Y as s,tt as t,kt as u};
