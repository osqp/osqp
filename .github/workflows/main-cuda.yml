name: Main-Cuda

on:
  push:
    branches: [ master, develop**, ci, cuda2dev ]
    tags:
      - '*'
  pull_request:
    branches: [ master, develop** ]

jobs:

  build_and_test:
      runs-on: [self-hosted, gpu]

      strategy:
        fail-fast: false

        matrix:
          os: [ubuntu-latest]
          python-version: [3.9]
          cmake_flags: ['', '-DUNITTESTS=ON -DCUDA_SUPPORT=ON']
          cmake_flags_extra: ['']

          include:
            - os: ubuntu-latest
              cmake_generator: "Unix Makefiles"

      defaults:
        run:
          # Required when using an activated conda environment in steps
          # See https://github.com/conda-incubator/setup-miniconda#IMPORTANT
          shell: bash -l {0}

      steps:
        - uses: actions/checkout@v2
          with:
            lfs: false
            submodules: recursive

        - name: Set up conda
          uses: conda-incubator/setup-miniconda@v2
          with:
            auto-update-conda: true
            python-version: ${{ matrix.python-version }}

        - name: Setup (Linux)
          run: |
            echo "LD_LIBRARY_PATH=$CONDA_PREFIX/lib" >> $GITHUB_ENV

        # Fetching mkl from the anaconda channel instead of defaults gives us the MKL runtime dynamic libraries
        # as well (mkl_rt.<dll/so>), required during the runtime testing steps.
        # MKL on Anaconda 2021.* seems to have inexplicably renamed mkl_rt.dll to mkl_rt.1.dll, so we insist on
        # a version earlier than 2021
        - name: Install python dependencies
          run: |
            conda install -c anaconda "mkl<2021" numpy scipy
            conda info
            conda list

        - name: Build
          run: |
            cmake -G "${{ matrix.cmake_generator }}" -S . -B build ${{ matrix.cmake_flags }} ${{ matrix.cmake_flags_extra }}
            cmake --build build

        # useful for inspecting the OSQP version information
        - name: OSQP Demo
          run: |
            ./build/out/osqp_demo
          if: ${{ !contains(matrix.cmake_flags_extra, 'EMBEDDED') }}

        - name: Test
          run: |
            ./build/out/osqp_tester
          if: ${{ matrix.cmake_flags == '-DUNITTESTS=ON -DCUDA_SUPPORT=ON' }}
